#!/bin/bash

set -e

#DEBHELPER#

# DKMS variables
DKMS_NAME="pamir-ai-sam"
DKMS_VERSION="3.0.0"
DKMS_SOURCE_DIR="/usr/src/${DKMS_NAME}-${DKMS_VERSION}"
source "${DKMS_SOURCE_DIR}/platform-detect.sh"

case "$1" in
configure)
	# Detect platform
	PLATFORM=$(detect_platform)
	if [ "$PLATFORM" = "unknown" ]; then
		echo "Warning: Unknown platform detected, skipping overlay installation" >&2
		exit 0
	fi
	echo "Detected platform: $PLATFORM"

	# Get platform-specific paths and names
	OVERLAY_DIR=$(get_overlay_dir "$PLATFORM")
	CONFIG_FILE=$(get_config_file "$PLATFORM")
	OVERLAY_NAME=$(get_overlay_name "$PLATFORM")
	DTS_FILE=$(get_dts_file "$PLATFORM")
	OVERLAY_SOURCE="${DKMS_SOURCE_DIR}/${DTS_FILE}"
	OVERLAY_DEST="${OVERLAY_DIR}${OVERLAY_NAME}.dtbo"

	# Create overlay directory if it doesn't exist
	if [ ! -d "$OVERLAY_DIR" ]; then
		echo "Creating overlay directory: $OVERLAY_DIR"
		mkdir -p "$OVERLAY_DIR"
	fi

	# Compile and install device tree overlay if source exists
	if [ -f "$OVERLAY_SOURCE" ] && [ -d "$OVERLAY_DIR" ]; then
		echo "Compiling device tree overlay from $OVERLAY_SOURCE..."
		if dtc -@ -I dts -O dtb -o "$OVERLAY_DEST" "$OVERLAY_SOURCE" 2>/dev/null; then
			echo "Device tree overlay successfully installed at $OVERLAY_DEST"

			if [ -f "$CONFIG_FILE" ]; then
				# Handle platform-specific overlay configuration syntax
				if [ "$PLATFORM" = "armbian" ] || [ "$PLATFORM" = "rockchip" ] || [ "$PLATFORM" = "armsom-rk3576" ]; then
					# Armbian/Rockchip: overlays= space-separated syntax
					if grep -q "^overlays=" "$CONFIG_FILE"; then
						# Check if overlay already exists in the list
						if ! grep "^overlays=" "$CONFIG_FILE" | grep -qE "(^overlays=|[[:space:]])${OVERLAY_NAME}([[:space:]]|$)"; then
							echo "Adding $OVERLAY_NAME to overlays list in $CONFIG_FILE"
							# Append to existing overlays= line
							sed -i "s/^overlays=\(.*\)/overlays=\1 $OVERLAY_NAME/" "$CONFIG_FILE"
							echo "Please reboot for the overlay to take effect"
						else
							echo "Overlay $OVERLAY_NAME already configured in $CONFIG_FILE"
						fi
					else
						# No overlays= line exists, create one
						echo "Creating overlays list with $OVERLAY_NAME in $CONFIG_FILE"
						echo "overlays=$OVERLAY_NAME" >>"$CONFIG_FILE"
						echo "Please reboot for the overlay to take effect"
					fi
				else
					# Raspberry Pi uses "dtoverlay=" with separate lines
					if ! grep -q "^dtoverlay=${OVERLAY_NAME}" "$CONFIG_FILE"; then
						echo "Adding overlay to $CONFIG_FILE"
						echo "dtoverlay=${OVERLAY_NAME}" >>"$CONFIG_FILE"
						echo "Please reboot for the overlay to take effect"
					else
						echo "Overlay already configured in $CONFIG_FILE"
					fi
				fi
			fi
		else
			echo "Warning: Failed to compile device tree overlay (this is normal if not on target hardware)"
		fi
	fi
	;;

abort-upgrade | abort-remove | abort-deconfigure) ;;

*)
	echo "postinst called with unknown argument '$1'" >&2
	exit 1
	;;
esac

exit 0
